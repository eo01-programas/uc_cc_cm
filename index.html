<!doctype html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Case Content & UPC Sticker | Web</title>
  <link rel="stylesheet" href="css/style.css" />
</head>

<body>
  <div class="app-container">
    <header class="app-header">
      <div class="logo">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
          class="lucide lucide-box">
          <path
            d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z" />
          <path d="m3.3 7 8.7 5 8.7-5" />
          <path d="M12 22v-9" />
        </svg>
        <span class="logo-text">Generador de Reportes</span>
      </div>
      <div class="header-badges">
        <span class="badge secondary">13/02/2026</span>
        <span class="badge">v02</span>
      </div>
    </header>

    <main class="main-content">
        <!-- Dashboard Grid -->
        <div class="dashboard-grid">

          <!-- Top Strip: Data Sources -->
          <div class="dashboard-top">
            <section class="card data-sources-card">
              <div class="card-body compact-row">
                <div class="upload-group compact">
                  <label class="upload-btn" for="pdf-files">
                    <span class="icon pdf">
                      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" />
                        <polyline points="14 2 14 8 20 8" />
                        <path d="M9 15l2 2 4-4" />
                      </svg>
                    </span>
                    <div class="text">
                      <span class="title">PDFs de Origen</span>
                      <span class="hint" id="pdf-hint">Seleccionar archivos...</span>
                    </div>
                    <input id="pdf-files" type="file" accept=".pdf" multiple />
                  </label>
                </div>

                <div class="divider-vertical"></div>

                <div class="upload-group compact">
                  <label class="upload-btn" for="excel-file">
                    <span class="icon excel">
                      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" />
                        <polyline points="14 2 14 8 20 8" />
                        <line x1="8" y1="13" x2="16" y2="13" />
                        <line x1="8" y1="17" x2="16" y2="17" />
                        <line x1="10" y1="9" x2="8" y2="9" />
                      </svg>
                    </span>
                    <div class="text">
                      <span class="title">Excel de Datos</span>
                      <span class="hint" id="excel-hint">Seleccionar archivo...</span>
                    </div>
                    <input id="excel-file" type="file" accept=".xlsx,.xls,.xlsm" />
                  </label>
                </div>
              </div>
            </section>
          </div>

          <!-- Left Column: Case Content -->
          <div class="dashboard-left">
            <section class="card h-100">
              <div class="card-header">
                <h2>Case Content</h2>
              </div>
              <div class="card-body column-body">
                <div class="image-upload full">
                  <label class="upload-area" for="case-img-file">
                    <svg class="upload-icon" xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                    <span class="placeholder-text">Click para subir<br>Imagen Referencial</span>
                    <input id="case-img-file" type="file" accept="image/*" />
                  </label>
                  <div class="preview-area" id="preview-case-img"></div>
                </div>
                <button class="btn btn-primary full-width" id="btn-case">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                  Generar Case Content
                </button>
              </div>
            </section>
          </div>

          <!-- Right Column: UPC Sticker -->
          <div class="dashboard-right">
            <section class="card h-100">
              <div class="card-header">
                <h2>UPC Sticker Generator</h2>
              </div>
              <div class="card-body">

                <!-- UPC Grid Table -->
                <div class="upc-matrix">
                  <!-- Header -->
                  <div class="matrix-header">
                    <div class="col-check">Activar</div>
                    <div class="col-dest">Destino</div>
                    <div class="col-imgs">Imágenes (Click para cambiar)</div>
                  </div>

                  <!-- Row: Regular -->
                  <div class="matrix-row" id="row-regular">
                    <div class="col-check">
                      <div class="toggle-switch">
                        <input id="opt-regular" type="checkbox" checked /> <!-- Default checked -->
                        <span class="slider"></span>
                      </div>
                    </div>
                    <div class="col-dest">
                      <span class="dest-name">Regular</span>
                      <button type="button" class="info-icon" data-info="regular">?</button>
                    </div>
                    <div class="col-imgs">
                      <div class="img-slot">
                        <label for="upc-img1-regular" title="Imagen 1">
                          <div class="mini-preview" id="preview-upc-img1-regular"></div>
                          <input id="upc-img1-regular" type="file" accept="image/*" />
                        </label>
                      </div>
                      <div class="img-slot">
                        <label for="upc-img2-regular" title="Imagen 2">
                          <div class="mini-preview" id="preview-upc-img2-regular"></div>
                          <input id="upc-img2-regular" type="file" accept="image/*" />
                        </label>
                      </div>
                    </div>
                  </div>

                  <!-- Row: Japan -->
                  <div class="matrix-row" id="row-japan">
                    <div class="col-check">
                      <div class="toggle-switch">
                        <input id="opt-japan" type="checkbox" />
                        <span class="slider"></span>
                      </div>
                    </div>
                    <div class="col-dest">
                      <span class="dest-name">Japón</span>
                      <button type="button" class="info-icon" data-info="japan">?</button>
                    </div>
                    <div class="col-imgs">
                      <div class="img-slot">
                        <label for="upc-img1-japan">
                          <div class="mini-preview" id="preview-upc-img1-japan"></div>
                          <input id="upc-img1-japan" type="file" accept="image/*" />
                        </label>
                      </div>
                      <div class="img-slot">
                        <label for="upc-img2-japan">
                          <div class="mini-preview" id="preview-upc-img2-japan"></div>
                          <input id="upc-img2-japan" type="file" accept="image/*" />
                        </label>
                      </div>
                    </div>
                  </div>

                  <!-- Row: Canada -->
                  <div class="matrix-row" id="row-canada">
                    <div class="col-check">
                      <div class="toggle-switch">
                        <input id="opt-canada" type="checkbox" />
                        <span class="slider"></span>
                      </div>
                    </div>
                    <div class="col-dest">
                      <span class="dest-name">Canadá</span>
                      <button type="button" class="info-icon" data-info="canada">?</button>
                    </div>
                    <div class="col-imgs">
                      <div class="img-slot">
                        <label for="upc-img1-canada">
                          <div class="mini-preview" id="preview-upc-img1-canada"></div>
                          <input id="upc-img1-canada" type="file" accept="image/*" />
                        </label>
                      </div>
                      <div class="img-slot">
                        <label for="upc-img2-canada">
                          <div class="mini-preview" id="preview-upc-img2-canada"></div>
                          <input id="upc-img2-canada" type="file" accept="image/*" />
                        </label>
                      </div>
                    </div>
                  </div>

                  <!-- Row: Brazil -->
                  <div class="matrix-row" id="row-brazil">
                    <div class="col-check">
                      <div class="toggle-switch">
                        <input id="opt-brazil" type="checkbox" />
                        <span class="slider"></span>
                      </div>
                    </div>
                    <div class="col-dest">
                      <span class="dest-name">Brasil</span>
                      <button type="button" class="info-icon" data-info="brazil">?</button>
                    </div>
                    <div class="col-imgs">
                      <div class="img-slot">
                        <label for="upc-img1-brazil">
                          <div class="mini-preview" id="preview-upc-img1-brazil"></div>
                          <input id="upc-img1-brazil" type="file" accept="image/*" />
                        </label>
                      </div>
                      <div class="img-slot">
                        <label for="upc-img2-brazil">
                          <div class="mini-preview" id="preview-upc-img2-brazil"></div>
                          <input id="upc-img2-brazil" type="file" accept="image/*" />
                        </label>
                      </div>
                    </div>
                  </div>

                </div>

                <div class="action-footer">
                  <button class="btn btn-secondary full-width" id="btn-upc">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                    Generar Reporte UPC
                  </button>
                </div>

              </div>
            </section>
          </div>
        </div>

        <!-- Modal de criterios -->
        <div class="modal-overlay" id="criteria-modal">
          <div class="modal-box">
            <div class="modal-header">
              <h3 id="modal-title"></h3>
              <button type="button" class="modal-close" id="modal-close">&times;</button>
            </div>
            <div class="modal-body" id="modal-body"></div>
          </div>
        </div>

        <div class="status-console" id="status">
          <span class="status-dot"></span>
          <span class="status-text">Sistema listo. Esperando archivos...</span>
        </div>

    </main>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>

  <script type="module">
    import {
      extractPdfRecords,
      readWorkbook,
      rowsToObjects,
    } from "./js/input.js";
    import {
      readCaseContentExcel,
      prepareCaseContentExcel,
      buildCaseContentData,
    } from "./js/case_content.js";
    import { generateCaseContentWorkbook } from "./js/output_case_content.js";
    import {
      readUpcExcel,
      prepareUpcExcel,
      buildUpcData,
    } from "./js/upc_sticker.js";
    import { generateUpcWorkbook } from "./js/output_upc_sticker.js";

    const pdfInput = document.getElementById("pdf-files");
    const excelInput = document.getElementById("excel-file");

    // Case Content Inputs
    const caseImgInput = document.getElementById("case-img-file");
    const previewCaseImg = document.getElementById("preview-case-img");

    // UPC Inputs - Separate for each destination
    const upcInputs = {
      regular: {
        img1: document.getElementById("upc-img1-regular"),
        img2: document.getElementById("upc-img2-regular"),
        preview1: document.getElementById("preview-upc-img1-regular"),
        preview2: document.getElementById("preview-upc-img2-regular"),
        section: document.getElementById("row-regular")
      },
      japan: {
        img1: document.getElementById("upc-img1-japan"),
        img2: document.getElementById("upc-img2-japan"),
        preview1: document.getElementById("preview-upc-img1-japan"),
        preview2: document.getElementById("preview-upc-img2-japan"),
        section: document.getElementById("row-japan")
      },
      canada: {
        img1: document.getElementById("upc-img1-canada"),
        img2: document.getElementById("upc-img2-canada"),
        preview1: document.getElementById("preview-upc-img1-canada"),
        preview2: document.getElementById("preview-upc-img2-canada"),
        section: document.getElementById("row-canada")
      },
      brazil: {
        img1: document.getElementById("upc-img1-brazil"),
        img2: document.getElementById("upc-img2-brazil"),
        preview1: document.getElementById("preview-upc-img1-brazil"),
        preview2: document.getElementById("preview-upc-img2-brazil"),
        section: document.getElementById("row-brazil")
      }
    };

    const statusEl = document.querySelector("#status .status-text");
    const statusDot = document.querySelector("#status .status-dot");

    const optRegular = document.getElementById("opt-regular");
    const optJapan = document.getElementById("opt-japan");
    const optCanada = document.getElementById("opt-canada");
    const optBrazil = document.getElementById("opt-brazil");

    // Map toggles to logic keys
    const toggleMap = [
      { el: optRegular, key: 'regular' },
      { el: optJapan, key: 'japan' },
      { el: optCanada, key: 'canada' },
      { el: optBrazil, key: 'brazil' }
    ];

    // ── Criteria Modal ──
    const criteriaModal = document.getElementById("criteria-modal");
    const modalTitle = document.getElementById("modal-title");
    const modalBody = document.getElementById("modal-body");
    const modalClose = document.getElementById("modal-close");

    const CRITERIA_INFO = {
      regular: {
        title: "Criterios — Regular (Por defecto)",
        html: `
          <p><b>Procesamiento estándar:</b> Se procesan todas las filas del Excel sin filtro de destino.</p>
          <p><b>Tallas:</b> Se mantienen las tallas originales sin conversión.</p>
          <p><b>UPC Code:</b> Se mantiene el código UPC original.</p>
          <div class="criteria-note">Adicionalmente se genera una hoja extra <b>"INDONESIA"</b> con todas las filas cuyo DESTINO sea INDONESIA.</div>
        `
      },
      japan: {
        title: "Criterios — Formato Japón",
        html: `
          <p><b>UPC Code:</b> Se agrega un <code>0</code> al inicio del código UPC si aún no lo tiene.</p>
          <div class="criteria-note">Se procesan todas las filas sin filtro de destino. Solo se modifica el formato del UPC.</div>
        `
      },
      canada: {
        title: "Criterios — Talla Canadá",
        html: `
          <p><b>Mapeo de tallas:</b></p>
          <table>
            <tr><th>Original</th><th>Canadá</th></tr>
            <tr><td>S</td><td>S/P</td></tr>
            <tr><td>M</td><td>M/M</td></tr>
            <tr><td>L</td><td>L/G</td></tr>
            <tr><td>XL</td><td>XL/TG</td></tr>
            <tr><td>2XL</td><td>2XL/TTG</td></tr>
            <tr><td>3XL</td><td>3XL/TTTG</td></tr>
          </table>
          <div class="criteria-note">Se procesan todas las filas sin filtro de destino. Solo se modifica la nomenclatura de tallas.</div>
        `
      },
      brazil: {
        title: "Criterios — Talla Brasil",
        html: `
          <p><b>Filtro:</b> Solo se procesan filas con <code>DESTINO = BRAZIL</code>.</p>
          <p><b>Mapeo de tallas:</b></p>
          <table>
            <tr><th>Original</th><th>Brasil</th></tr>
            <tr><td>XS</td><td>XS/PP</td></tr>
            <tr><td>S</td><td>S/P</td></tr>
            <tr><td>M</td><td>M/M</td></tr>
            <tr><td>L</td><td>L/G</td></tr>
            <tr><td>XL</td><td>XL/GG</td></tr>
            <tr><td>XXL</td><td>XXL/XGG</td></tr>
          </table>
          <div class="criteria-note">Se filtran solo las filas donde DESTINO sea exactamente BRAZIL.</div>
        `
      }
    };

    document.querySelectorAll(".info-icon").forEach((btn) => {
      btn.addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation();
        const key = btn.dataset.info;
        const info = CRITERIA_INFO[key];
        if (!info) return;
        modalTitle.textContent = info.title;
        modalBody.innerHTML = info.html;
        criteriaModal.classList.add("active");
      });
    });

    modalClose.addEventListener("click", () => criteriaModal.classList.remove("active"));
    criteriaModal.addEventListener("click", (e) => {
      if (e.target === criteriaModal) criteriaModal.classList.remove("active");
    });

    // Store default blobs
    let defaultCaseBlob = null;
    const defaultBlobs = {
      regular: { img1: null, img2: null },
      japan:   { img1: null, img2: null },
      canada:  { img1: null, img2: null },
      brazil:  { img1: null, img2: null }
    };

    // UI Helpers for file inputs
    const updateFileHint = (input, hintId) => {
      const hint = document.getElementById(hintId);
      if (input.files.length > 0) {
        hint.textContent = `${input.files.length} archivo(s)`;
        hint.classList.add('selected');
        hint.parentElement.parentElement.classList.add('has-files');
      } else {
        hint.textContent = "Arrastra o clic";
        hint.classList.remove('selected');
        hint.parentElement.parentElement.classList.remove('has-files');
      }
    };

    pdfInput.addEventListener('change', () => updateFileHint(pdfInput, 'pdf-hint'));
    excelInput.addEventListener('change', () => updateFileHint(excelInput, 'excel-hint'));

    pdfjsLib.GlobalWorkerOptions.workerSrc =
      "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

    const setStatus = (message, type = 'info') => {
      statusEl.textContent = message;
      statusDot.className = 'status-dot'; // reset
      if (type === 'processing') statusDot.classList.add('processing');
      if (type === 'error') statusDot.classList.add('error');
      if (type === 'success') statusDot.classList.add('success');
    };

    const showPreview = (fileOrBlob, container) => {
      if (!fileOrBlob) {
        container.innerHTML = "";
        return;
      }
      const reader = new FileReader();
      reader.onload = () => {
        container.innerHTML = "";
        const img = document.createElement("img");
        img.src = reader.result;
        container.appendChild(img);
      };
      reader.readAsDataURL(fileOrBlob);
    };

    // Load default images for Case Content and all UPC destinations
    const loadDefaultImages = async () => {
      try {
        // Case Content default
        const resCase = await fetch('case_content/imagen 1.png');
        if (resCase.ok) {
          defaultCaseBlob = await resCase.blob();
          if (!caseImgInput.files.length) showPreview(defaultCaseBlob, previewCaseImg);
        }
      } catch (e) {
        console.warn('Could not load default case image', e);
      }

      // UPC images per destination
      const suffixMap = { regular: 'rr', japan: 'jp', canada: 'ca', brazil: 'br' };

      for (const [key, suffix] of Object.entries(suffixMap)) {
        const inputs = upcInputs[key];
        for (const [idx, previewEl, inputEl] of [
          ['1', inputs.preview1, inputs.img1],
          ['2', inputs.preview2, inputs.img2]
        ]) {
          if (inputEl.files.length) continue; // user already selected a file
          const filename = `imagen${idx}_${suffix}.png`;
          try {
            const res = await fetch(`upc_sticker/${filename}?t=${Date.now()}`);
            if (res.ok) {
              const blob = await res.blob();
              defaultBlobs[key][`img${idx}`] = blob;
              showPreview(blob, previewEl);
            }
          } catch (e) {
            console.warn(`Could not load ${filename}`, e);
          }
        }
      }
    };

    loadDefaultImages();

    // Toggle Event Listeners
    // Toggle Event Listeners
    const handleToggleChange = () => {
      toggleMap.forEach(({ el, key }) => {
        const row = upcInputs[key].section;
        if (el.checked) {
          row.classList.remove('disabled');
        } else {
          row.classList.add('disabled');
        }
      });
    };

    toggleMap.forEach(({ el }) => el.addEventListener('change', handleToggleChange));
    // Init state
    handleToggleChange();

    // Event listeners for file inputs (previews)
    Object.values(upcInputs).forEach(group => {
      group.img1.addEventListener('change', () => {
        if (group.img1.files[0]) showPreview(group.img1.files[0], group.preview1);
      });
      group.img2.addEventListener('change', () => {
        if (group.img2.files[0]) showPreview(group.img2.files[0], group.preview2);
      });
    });

    caseImgInput.addEventListener("change", () => {
      if (caseImgInput.files[0]) {
        showPreview(caseImgInput.files[0], previewCaseImg);
      } else if (defaultCaseBlob) {
        showPreview(defaultCaseBlob, previewCaseImg);
      } else {
        previewCaseImg.innerHTML = "";
      }
    });


    const validateInputs = () => {
      if (!pdfInput.files.length) throw new Error("Faltan los PDFs de origen.");
      if (!excelInput.files.length) throw new Error("Falta el Excel de datos.");
    };

    const downloadWorkbook = async (workbook, filename) => {
      const buffer = await workbook.xlsx.writeBuffer();
      const blob = new Blob([buffer], {
        type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
      });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      link.remove();
      URL.revokeObjectURL(url);
    };

    const handleCaseContent = async () => {
      try {
        validateInputs();
        setStatus("Case: Leyendo PDFs...", "processing");
        const pdfFiles = Array.from(pdfInput.files);
        const pdfRows = await extractPdfRecords(pdfFiles, {
          stylePattern: /^TP\d+[A-Z]?\b/,
          colorPattern: /^([A-Z0-9]{3,4})\s+([A-Z0-9/ .\-]+?)(?:\s+((?:\d{11,14}\s+)*\d{11,14}))?\s*$/,
        });

        if (!pdfRows.length) throw new Error("No se extrajo información de los PDFs (Case Content).");

        setStatus("Case: Leyendo Excel...", "processing");
        const workbook = await readWorkbook(excelInput.files[0]);
        const { rows, headerRow } = readCaseContentExcel(workbook);
        const { objects } = rowsToObjects(rows, headerRow);
        const prepared = prepareCaseContentExcel(objects);

        setStatus("Case: Procesando datos...", "processing");
        const finalRows = buildCaseContentData(pdfRows, prepared);

        setStatus("Case: Generando Excel...", "processing");
        // Use uploaded file OR default blob
        const imgFile = caseImgInput.files[0] || defaultCaseBlob;

        const outputWorkbook = await generateCaseContentWorkbook(
          finalRows,
          imgFile,
        );

        await downloadWorkbook(outputWorkbook, "Case_Content_Report.xlsx");
        setStatus(`Case Content generado: ${finalRows.length} filas.`, "success");
      } catch (err) {
        setStatus(`Error Case: ${err.message}`, "error");
        console.error(err);
      }
    };

    const handleUpc = async () => {
      try {
        // Collect selected criteria
        const criteria = [];
        if (optRegular.checked) criteria.push({ id: 'regular', suffix: 'rr', name: 'Regular' });
        if (optJapan.checked) criteria.push({ id: 'japan', suffix: 'jp', name: 'Japón' });
        if (optCanada.checked) criteria.push({ id: 'canada', suffix: 'ca', name: 'Canadá' });
        if (optBrazil.checked) criteria.push({ id: 'brazil', suffix: 'br', name: 'Brasil' });

        if (!criteria.length) {
          throw new Error("Seleccione al menos un tipo de proceso (Regular, Japón, Canadá o Brasil).");
        }

        validateInputs();
        setStatus("UPC: Leyendo PDFs...", "processing");
        const pdfFiles = Array.from(pdfInput.files);
        const pdfRows = await extractPdfRecords(pdfFiles, {
          stylePattern: /^([A-Z]{2}\d+[A-Z]?)\b/,
          colorPattern: /^([A-Z0-9]{3,5})\s+([A-Z0-9/ .\-]+?)(?:\s+((?:\d{11,14}\s+)*\d{11,14}))?\s*$/,
        });

        if (!pdfRows.length) throw new Error("No se extrajo información de los PDFs (UPC).");

        setStatus("UPC: Leyendo Excel...", "processing");
        const workbook = await readWorkbook(excelInput.files[0]);
        const { rows, headerRow } = readUpcExcel(workbook);
        const { objects } = rowsToObjects(rows, headerRow);
        const prepared = prepareUpcExcel(objects);

        setStatus("UPC: Procesando datos...", "processing");

        let outputWorkbook = new ExcelJS.Workbook();
        let totalRows = 0;

        for (const crit of criteria) {
          setStatus(`UPC: Procesando ${crit.name}...`, "processing");

          // Build data for this criteria
          const options = { [crit.id]: true };
          const builtData = buildUpcData(pdfRows, prepared, options);
          const critRows = builtData.rows;
          totalRows += critRows.length;

          // Determine images
          const inputs = upcInputs[crit.id];

          let img1, img2;

          if (inputs.img1.files[0]) {
            img1 = inputs.img1.files[0];
          } else {
            img1 = defaultBlobs[crit.id].img1;
          }

          if (inputs.img2.files[0]) {
            img2 = inputs.img2.files[0];
          } else {
            img2 = defaultBlobs[crit.id].img2;
          }

          // Generate sheets into shared workbook
          const workbookOptions = {
            ...options,
            sheetSuffix: crit.name === 'Regular' ? 'Reg' : crit.suffix.toUpperCase()
          };

          await generateUpcWorkbook(critRows, img1, img2, workbookOptions, outputWorkbook);
        }

        setStatus("UPC: Descargando...", "processing");

        const nameParts = ["UPC_Report", ...criteria.map(c => c.suffix.toUpperCase())];
        const filename = `${nameParts.join("_")}.xlsx`;

        await downloadWorkbook(outputWorkbook, filename);
        setStatus(`UPC generado: ${criteria.length} criterios procesados.`, "success");
      } catch (err) {
        setStatus(`Error UPC: ${err.message}`, "error");
        console.error(err);
      }
    };

    document.getElementById("btn-case").addEventListener("click", handleCaseContent);
    document.getElementById("btn-upc").addEventListener("click", handleUpc);
  </script>
</body>

</html>
