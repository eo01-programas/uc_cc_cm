<!doctype html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Case Content & UPC Sticker | Web</title>
  <link rel="stylesheet" href="css/style.css" />
</head>

<body>
  <div class="app-container">
    <header class="app-header">
      <div class="logo">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
          class="lucide lucide-box">
          <path
            d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z" />
          <path d="m3.3 7 8.7 5 8.7-5" />
          <path d="M12 22v-9" />
        </svg>
        <span class="logo-text">Generador de Reportes</span>
      </div>
      <div class="header-badges">
        <span class="badge secondary">11/02/2026</span>
        <span class="badge">v01</span>
      </div>
    </header>

    <main class="main-content">
      <div class="grid-layout">
        <!-- Top: Common Inputs -->
        <div class="section-common">
          <section class="card">
            <div class="card-header">
              <h2>1. Datos Comunes</h2>
              <h2>1. Datos Comunes</h2>
            </div>
            <div class="card-body row-body">
              <div class="upload-group">
                <label class="upload-box" for="pdf-files">
                  <div class="icon-wrapper pdf">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                      stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" />
                      <polyline points="14 2 14 8 20 8" />
                      <path d="M9 15l2 2 4-4" />
                    </svg>
                  </div>
                  <div class="upload-text">
                    <span class="upload-title">PDFs de Origen</span>
                    <span class="upload-hint" id="pdf-hint">Arrastra o clic</span>
                  </div>
                  <input id="pdf-files" type="file" accept=".pdf" multiple />
                </label>
              </div>

              <div class="upload-group">
                <label class="upload-box" for="excel-file">
                  <div class="icon-wrapper excel">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                      stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" />
                      <polyline points="14 2 14 8 20 8" />
                      <line x1="8" y1="13" x2="16" y2="13" />
                      <line x1="8" y1="17" x2="16" y2="17" />
                      <line x1="10" y1="9" x2="8" y2="9" />
                    </svg>
                  </div>
                  <div class="upload-text">
                    <span class="upload-title">Excel de Datos</span>
                    <span class="upload-hint" id="excel-hint">Arrastra o clic</span>
                  </div>
                  <input id="excel-file" type="file" accept=".xlsx,.xls,.xlsm" />
                </label>
              </div>
            </div>
          </section>
        </div>

        <!-- Bottom: Split Workflows -->
        <div class="workflows-container">
          <!-- Workflow 1: Case Content -->
          <section class="card workflow-card">
            <div class="card-header">
              <h2>2. Case Content</h2>
              <div class="workflow-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                  <polyline points="7 10 12 15 17 10" />
                  <line x1="12" y1="15" x2="12" y2="3" />
                </svg>
              </div>
            </div>
            <div class="card-body">
              <div class="image-upload">
                <label class="upload-box mini" for="case-img-file">
                  <span class="upload-label">Imagen Referencial</span>
                  <input id="case-img-file" type="file" accept="image/*" />
                </label>
                <div class="preview-mini" id="preview-case-img"></div>
              </div>

              <div class="workflow-actions">
                <button class="btn btn-primary full-width" id="btn-case">
                  Generar Reporte Case Content
                </button>
              </div>
            </div>
          </section>

          <!-- Workflow 2: UPC Sticker -->
          <section class="card workflow-card">
            <div class="card-header">
              <h2>3. UPC Sticker</h2>
              <div class="workflow-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <rect width="8" height="4" x="8" y="2" rx="1" ry="1" />
                  <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2" />
                  <path d="M12 11h4" />
                  <path d="M12 16h4" />
                  <path d="M8 11h.01" />
                  <path d="M8 16h.01" />
                </svg>
              </div>
            </div>
            <div class="card-body">
              <div class="images-grid">
                <div class="image-upload">
                  <label class="upload-box mini" for="upc-img1-file">
                    <span class="upload-label">Imagen 1</span>
                    <input id="upc-img1-file" type="file" accept="image/*" />
                  </label>
                  <div class="preview-mini" id="preview-upc-img1"></div>
                </div>
                <div class="image-upload">
                  <label class="upload-box mini" for="upc-img2-file">
                    <span class="upload-label">Imagen 2</span>
                    <input id="upc-img2-file" type="file" accept="image/*" />
                  </label>
                  <div class="preview-mini" id="preview-upc-img2"></div>
                </div>
              </div>

              <div class="toggles compact">
                <label class="toggle-row">
                  <div class="toggle-switch">
                    <input id="opt-regular" type="checkbox" />
                    <span class="slider"></span>
                  </div>
                  <span class="toggle-label">Regular</span>
                  <button type="button" class="info-btn" data-info="regular" title="Ver criterios">
                    <svg xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 24 24" fill="none"
                      stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <circle cx="11" cy="11" r="8" />
                      <path d="m21 21-4.3-4.3" />
                    </svg>
                  </button>
                </label>
                <label class="toggle-row">
                  <div class="toggle-switch">
                    <input id="opt-japan" type="checkbox" />
                    <span class="slider"></span>
                  </div>
                  <span class="toggle-label">Formato Japón</span>
                  <button type="button" class="info-btn" data-info="japan" title="Ver criterios">
                    <svg xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 24 24" fill="none"
                      stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <circle cx="11" cy="11" r="8" />
                      <path d="m21 21-4.3-4.3" />
                    </svg>
                  </button>
                </label>
                <label class="toggle-row">
                  <div class="toggle-switch">
                    <input id="opt-canada" type="checkbox" />
                    <span class="slider"></span>
                  </div>
                  <span class="toggle-label">Talla Canadá</span>
                  <button type="button" class="info-btn" data-info="canada" title="Ver criterios">
                    <svg xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 24 24" fill="none"
                      stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <circle cx="11" cy="11" r="8" />
                      <path d="m21 21-4.3-4.3" />
                    </svg>
                  </button>
                </label>
                <label class="toggle-row">
                  <div class="toggle-switch">
                    <input id="opt-brazil" type="checkbox" />
                    <span class="slider"></span>
                  </div>
                  <span class="toggle-label">Talla Brasil</span>
                  <button type="button" class="info-btn" data-info="brazil" title="Ver criterios">
                    <svg xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 24 24" fill="none"
                      stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <circle cx="11" cy="11" r="8" />
                      <path d="m21 21-4.3-4.3" />
                    </svg>
                  </button>
                </label>
              </div>

              <div class="workflow-actions">
                <button class="btn btn-secondary full-width" id="btn-upc">
                  Generar Reporte UPC
                </button>
              </div>
            </div>
          </section>
        </div>
      </div>

      <!-- Modal de criterios -->
      <div class="modal-overlay" id="criteria-modal">
        <div class="modal-box">
          <div class="modal-header">
            <h3 id="modal-title"></h3>
            <button type="button" class="modal-close" id="modal-close">&times;</button>
          </div>
          <div class="modal-body" id="modal-body"></div>
        </div>
      </div>

      <div class="status-console" id="status">
        <span class="status-dot"></span>
        <span class="status-text">Sistema listo. Esperando archivos...</span>
      </div>

    </main>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>

  <script type="module">
    import {
      extractPdfRecords,
      readWorkbook,
      rowsToObjects,
    } from "./js/input.js";
    import {
      readCaseContentExcel,
      prepareCaseContentExcel,
      buildCaseContentData,
    } from "./js/case_content.js";
    import { generateCaseContentWorkbook } from "./js/output_case_content.js";
    import {
      readUpcExcel,
      prepareUpcExcel,
      buildUpcData,
    } from "./js/upc_sticker.js";
    import { generateUpcWorkbook } from "./js/output_upc_sticker.js";

    const pdfInput = document.getElementById("pdf-files");
    const excelInput = document.getElementById("excel-file");

    // Case Content Inputs
    const caseImgInput = document.getElementById("case-img-file");
    const previewCaseImg = document.getElementById("preview-case-img");

    // UPC Inputs
    const upcImg1Input = document.getElementById("upc-img1-file");
    const upcImg2Input = document.getElementById("upc-img2-file");
    const previewUpcImg1 = document.getElementById("preview-upc-img1");
    const previewUpcImg2 = document.getElementById("preview-upc-img2");

    const statusEl = document.querySelector("#status .status-text");
    const statusDot = document.querySelector("#status .status-dot");

    const optRegular = document.getElementById("opt-regular");
    const optJapan = document.getElementById("opt-japan");
    const optCanada = document.getElementById("opt-canada");
    const optBrazil = document.getElementById("opt-brazil");

    // ── Criteria Modal ──
    const criteriaModal = document.getElementById("criteria-modal");
    const modalTitle = document.getElementById("modal-title");
    const modalBody = document.getElementById("modal-body");
    const modalClose = document.getElementById("modal-close");

    const CRITERIA_INFO = {
      regular: {
        title: "Criterios — Regular (Por defecto)",
        html: `
          <p><b>Procesamiento estándar:</b> Se procesan todas las filas del Excel sin filtro de destino.</p>
          <p><b>Tallas:</b> Se mantienen las tallas originales sin conversión.</p>
          <p><b>UPC Code:</b> Se mantiene el código UPC original.</p>
          <div class="criteria-note">Adicionalmente se genera una hoja extra <b>"INDONESIA"</b> con todas las filas cuyo DESTINO sea INDONESIA.</div>
        `
      },
      japan: {
        title: "Criterios — Formato Japón",
        html: `
          <p><b>UPC Code:</b> Se agrega un <code>0</code> al inicio del código UPC si aún no lo tiene.</p>
          <div class="criteria-note">Se procesan todas las filas sin filtro de destino. Solo se modifica el formato del UPC.</div>
        `
      },
      canada: {
        title: "Criterios — Talla Canadá",
        html: `
          <p><b>Mapeo de tallas:</b></p>
          <table>
            <tr><th>Original</th><th>Canadá</th></tr>
            <tr><td>S</td><td>S/P</td></tr>
            <tr><td>M</td><td>M/M</td></tr>
            <tr><td>L</td><td>L/G</td></tr>
            <tr><td>XL</td><td>XL/TG</td></tr>
            <tr><td>2XL</td><td>2XL/TTG</td></tr>
            <tr><td>3XL</td><td>3XL/TTTG</td></tr>
          </table>
          <div class="criteria-note">Se procesan todas las filas sin filtro de destino. Solo se modifica la nomenclatura de tallas.</div>
        `
      },
      brazil: {
        title: "Criterios — Talla Brasil",
        html: `
          <p><b>Filtro:</b> Solo se procesan filas con <code>DESTINO = BRAZIL</code>.</p>
          <p><b>Mapeo de tallas:</b></p>
          <table>
            <tr><th>Original</th><th>Brasil</th></tr>
            <tr><td>XS</td><td>XS/PP</td></tr>
            <tr><td>S</td><td>S/P</td></tr>
            <tr><td>M</td><td>M/M</td></tr>
            <tr><td>L</td><td>L/G</td></tr>
            <tr><td>XL</td><td>XL/GG</td></tr>
            <tr><td>XXL</td><td>XXL/XGG</td></tr>
          </table>
          <div class="criteria-note">Se filtran solo las filas donde DESTINO sea exactamente BRAZIL.</div>
        `
      }
    };

    document.querySelectorAll(".info-btn").forEach((btn) => {
      btn.addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation();
        const key = btn.dataset.info;
        const info = CRITERIA_INFO[key];
        if (!info) return;
        modalTitle.textContent = info.title;
        modalBody.innerHTML = info.html;
        criteriaModal.classList.add("active");
      });
    });

    modalClose.addEventListener("click", () => criteriaModal.classList.remove("active"));
    criteriaModal.addEventListener("click", (e) => {
      if (e.target === criteriaModal) criteriaModal.classList.remove("active");
    });

    // Store default blobs
    let defaultCaseBlob = null;
    let defaultUpcBlob1 = null;
    let defaultUpcBlob2 = null;

    // UI Helpers for file inputs
    const updateFileHint = (input, hintId) => {
      const hint = document.getElementById(hintId);
      if (input.files.length > 0) {
        hint.textContent = `${input.files.length} archivo(s)`;
        hint.classList.add('selected');
        hint.parentElement.parentElement.classList.add('has-files');
      } else {
        hint.textContent = "Arrastra o clic";
        hint.classList.remove('selected');
        hint.parentElement.parentElement.classList.remove('has-files');
      }
    };

    pdfInput.addEventListener('change', () => updateFileHint(pdfInput, 'pdf-hint'));
    excelInput.addEventListener('change', () => updateFileHint(excelInput, 'excel-hint'));

    pdfjsLib.GlobalWorkerOptions.workerSrc =
      "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

    const setStatus = (message, type = 'info') => {
      statusEl.textContent = message;
      statusDot.className = 'status-dot'; // reset
      if (type === 'processing') statusDot.classList.add('processing');
      if (type === 'error') statusDot.classList.add('error');
      if (type === 'success') statusDot.classList.add('success');
    };

    const showPreview = (fileOrBlob, container, isDefault = false) => {
      if (!fileOrBlob) {
        container.innerHTML = "";
        return;
      }
      const reader = new FileReader();
      reader.onload = () => {
        container.innerHTML = "";
        const img = document.createElement("img");
        img.src = reader.result;
        container.appendChild(img);
        if (isDefault) {
          const label = document.createElement("span");
          label.textContent = "Imagen del Proyecto (Por defecto)";
          label.style.cssText = "position: absolute; bottom: 4px; left: 4px; background: rgba(0,0,0,0.6); color: white; font-size: 10px; padding: 2px 6px; border-radius: 4px;";
          container.style.position = "relative";
          container.appendChild(label);
        }
      };
      reader.readAsDataURL(fileOrBlob);
    };

    // Load defaults with specific suffix (or empty for default)
    const loadDefaultImages = async (suffix = '') => {
      try {
        // Case Content
        if (!suffix) {
          const resCase = await fetch('case_content/imagen 1.png');
          if (resCase.ok) {
            defaultCaseBlob = await resCase.blob();
            if (!caseImgInput.files.length) showPreview(defaultCaseBlob, previewCaseImg, true);
          }
        }

        // Construct filenames
        const filename1 = suffix ? `imagen1_${suffix}.png` : `imagen1_rr.png`;
        const filename2 = suffix ? `imagen2_${suffix}.png` : `imagen2_rr.png`;

        // Helper to load or show error
        const loadOrError = async (filename, defaultBlob, input, container) => {
          if (input.files.length) return; // User manually selected file, ignore

          try {
            // Add timestamp to prevent caching
            const res = await fetch(`upc_sticker/${filename}?t=${new Date().getTime()}`);
            if (res.ok) {
              const blob = await res.blob();
              // Update global defaults if standard
              if (!suffix && filename.includes('imagen1')) defaultUpcBlob1 = blob;
              if (!suffix && filename.includes('imagen2')) defaultUpcBlob2 = blob;

              showPreview(blob, container, true);
            } else {
              // File missing
              if (suffix) {
                container.innerHTML = `<div style="color: red; font-size: 11px; padding: 10px; text-align: center; border: 1px dashed red;">
                            Imagen no encontrada:<br><b>${filename}</b><br>
                            <span style="color: #666; font-size: 10px;">Suba el archivo a la carpeta del proyecto.</span>
                         </div>`;
              } else {
                // Default file missing
                container.innerHTML = `<span style="color: #999; font-size: 11px;">Imagen por defecto no encontrada.</span>`;
              }
            }
          } catch (e) {
            console.error(e);
            container.textContent = "Error loading image";
          }
        };

        await loadOrError(filename1, defaultUpcBlob1, upcImg1Input, previewUpcImg1);
        await loadOrError(filename2, defaultUpcBlob2, upcImg2Input, previewUpcImg2);

      } catch (e) {
        console.warn("Could not load default images", e);
      }
    };

    loadDefaultImages();

    // Toggle Event Listeners - Allow multiple selection
    // Removed mutual exclusivity logic
    const allToggles = [optRegular, optJapan, optCanada, optBrazil];
    const handleToggleChange = (e) => {
      // Just update visual state if needed, but currently no extra logic needed for multiple selection
    };

    allToggles.forEach((t) => t.addEventListener('change', handleToggleChange));

    caseImgInput.addEventListener("change", () => {
      if (caseImgInput.files[0]) {
        showPreview(caseImgInput.files[0], previewCaseImg);
      } else if (defaultCaseBlob) {
        showPreview(defaultCaseBlob, previewCaseImg, true);
      } else {
        previewCaseImg.innerHTML = "";
      }
    });

    upcImg1Input.addEventListener("change", () => {
      if (upcImg1Input.files[0]) {
        showPreview(upcImg1Input.files[0], previewUpcImg1);
      } else if (defaultUpcBlob1) {
        showPreview(defaultUpcBlob1, previewUpcImg1, true);
      } else {
        previewUpcImg1.innerHTML = "";
      }
    });

    upcImg2Input.addEventListener("change", () => {
      if (upcImg2Input.files[0]) {
        showPreview(upcImg2Input.files[0], previewUpcImg2);
      } else if (defaultUpcBlob2) {
        showPreview(defaultUpcBlob2, previewUpcImg2, true);
      } else {
        previewUpcImg2.innerHTML = "";
      }
    });


    const validateInputs = () => {
      if (!pdfInput.files.length) throw new Error("Faltan los PDFs de origen.");
      if (!excelInput.files.length) throw new Error("Falta el Excel de datos.");
    };

    const downloadWorkbook = async (workbook, filename) => {
      const buffer = await workbook.xlsx.writeBuffer();
      const blob = new Blob([buffer], {
        type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
      });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      link.remove();
      URL.revokeObjectURL(url);
    };

    const handleCaseContent = async () => {
      try {
        validateInputs();
        setStatus("Case: Leyendo PDFs...", "processing");
        const pdfFiles = Array.from(pdfInput.files);
        const pdfRows = await extractPdfRecords(pdfFiles, {
          stylePattern: /^TP\d+[A-Z]?\b/,
          colorPattern: /^([A-Z0-9]{3,4})\s+([A-Z0-9/ .\-]+?)(?:\s+((?:\d{11,14}\s+)*\d{11,14}))?\s*$/,
        });

        if (!pdfRows.length) throw new Error("No se extrajo información de los PDFs (Case Content).");

        setStatus("Case: Leyendo Excel...", "processing");
        const workbook = await readWorkbook(excelInput.files[0]);
        const { rows, headerRow } = readCaseContentExcel(workbook);
        const { objects } = rowsToObjects(rows, headerRow);
        const prepared = prepareCaseContentExcel(objects);

        setStatus("Case: Procesando datos...", "processing");
        const finalRows = buildCaseContentData(pdfRows, prepared);

        setStatus("Case: Generando Excel...", "processing");
        // Use uploaded file OR default blob
        const imgFile = caseImgInput.files[0] || defaultCaseBlob;

        const outputWorkbook = await generateCaseContentWorkbook(
          finalRows,
          imgFile,
        );

        await downloadWorkbook(outputWorkbook, "Case_Content_Report.xlsx");
        setStatus(`Case Content generado: ${finalRows.length} filas.`, "success");
      } catch (err) {
        setStatus(`Error Case: ${err.message}`, "error");
        console.error(err);
      }
    };

    const fetchImageBlob = async (filename) => {
      try {
        const res = await fetch(`upc_sticker/${filename}?t=${new Date().getTime()}`);
        if (res.ok) return await res.blob();
      } catch (e) { console.warn("Image fetch fail", filename); }
      return null;
    };

    const handleUpc = async () => {
      try {
        // Collect selected criteria
        const criteria = [];
        if (optRegular.checked) criteria.push({ id: 'regular', suffix: 'rr', name: 'Regular' });
        if (optJapan.checked) criteria.push({ id: 'japan', suffix: 'jp', name: 'Japón' });
        if (optCanada.checked) criteria.push({ id: 'canada', suffix: 'ca', name: 'Canadá' });
        if (optBrazil.checked) criteria.push({ id: 'brazil', suffix: 'br', name: 'Brasil' });

        if (!criteria.length) {
          throw new Error("Seleccione al menos un tipo de proceso (Regular, Japón, Canadá o Brasil).");
        }

        validateInputs();
        setStatus("UPC: Leyendo PDFs...", "processing");
        const pdfFiles = Array.from(pdfInput.files);
        const pdfRows = await extractPdfRecords(pdfFiles, {
          stylePattern: /^([A-Z]{2}\d+[A-Z]?)\b/,
          colorPattern: /^([A-Z0-9]{3,5})\s+([A-Z0-9/ .\-]+?)(?:\s+((?:\d{11,14}\s+)*\d{11,14}))?\s*$/,
        });

        if (!pdfRows.length) throw new Error("No se extrajo información de los PDFs (UPC).");

        setStatus("UPC: Leyendo Excel...", "processing");
        const workbook = await readWorkbook(excelInput.files[0]);
        const { rows, headerRow } = readUpcExcel(workbook);
        const { objects } = rowsToObjects(rows, headerRow);
        const prepared = prepareUpcExcel(objects);

        setStatus("UPC: Procesando datos...", "processing");

        let outputWorkbook = new ExcelJS.Workbook();
        let totalRows = 0;

        for (const crit of criteria) {
          setStatus(`UPC: Procesando ${crit.name}...`, "processing");

          // Build data for this criteria
          const options = { [crit.id]: true };
          const builtData = buildUpcData(pdfRows, prepared, options);
          const critRows = builtData.rows;
          totalRows += critRows.length;

          // Determine images
          // Logic: 
          // 1. If user uploaded a custom file manually in UI, use that (override everything).
          // 2. Else, try to fetch the specific default for this crit (e.g. imagen1_jp.png). 
          //    Note: Our previous logic loaded defaults into global vars defaultUpcBlob1/2 based on "last selected".
          //    Here we should fetch dynamically if using defaults to ensure correctness per sheet.

          let img1 = upcImg1Input.files[0];
          let img2 = upcImg2Input.files[0];

          if (!img1) {
            // Fetch dynamic default
            const filename1 = crit.id === 'regular' ? `imagen1_rr.png` : `imagen1_${crit.suffix}.png`;
            img1 = await fetchImageBlob(filename1);
          }
          if (!img2) {
            const filename2 = crit.id === 'regular' ? `imagen2_rr.png` : `imagen2_${crit.suffix}.png`;
            img2 = await fetchImageBlob(filename2);
          }

          // Generate sheets into shared workbook
          // Sheet suffix is used to distinguish sheets e.g. "Style 1 (JP)"
          const workbookOptions = {
            ...options,
            sheetSuffix: crit.name === 'Regular' ? 'Reg' : crit.suffix.toUpperCase()
          };

          await generateUpcWorkbook(critRows, img1, img2, workbookOptions, outputWorkbook);
        }

        setStatus("UPC: Descargando...", "processing");

        const nameParts = ["UPC_Report", ...criteria.map(c => c.suffix.toUpperCase())];
        const filename = `${nameParts.join("_")}.xlsx`;

        await downloadWorkbook(outputWorkbook, filename);
        setStatus(`UPC generado: ${criteria.length} criterios procesados.`, "success");
      } catch (err) {
        setStatus(`Error UPC: ${err.message}`, "error");
        console.error(err);
      }
    };

    document.getElementById("btn-case").addEventListener("click", handleCaseContent);
    document.getElementById("btn-upc").addEventListener("click", handleUpc);
  </script>
</body>

</html>